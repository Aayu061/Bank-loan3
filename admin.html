<!doctype html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="api-base" content="https://nexa-bank.onrender.com" />
  <title>Nexa — Admin Dashboard</title>
  <link rel="icon" href="N.png" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config={darkMode:'class',theme:{extend:{colors:{brand:{DEFAULT:'#7c3aed',dark:'#6d28d9'}}}}}</script>
</head>
<body class="min-h-screen text-slate-100">
  <div class="flex">
    <aside class="w-64 bg-slate-900 min-h-screen p-4">
      <a href="index.html" class="flex items-center gap-2 mb-6"><img src="Nexa Bank.png" class="site-logo" alt="logo"/></a>
      <nav class="space-y-2 text-sm">
        <a class="block px-3 py-2 rounded hover:bg-slate-800">Dashboard</a>
        <a class="block px-3 py-2 rounded hover:bg-slate-800">Applications</a>
        <a class="block px-3 py-2 rounded hover:bg-slate-800">Loans</a>
        <a class="block px-3 py-2 rounded hover:bg-slate-800">Users</a>
        <a class="block px-3 py-2 rounded hover:bg-slate-800">Payments</a>
        <a class="block px-3 py-2 rounded hover:bg-slate-800">Reports</a>
      </nav>
    </aside>

    <main class="flex-1 p-6">
      <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-bold">Admin Dashboard</h1>
        <div id="adminBox" class="flex items-center gap-3"><div id="adminName">Admin</div><button id="adminLogout" class="px-3 py-1 rounded bg-slate-800/40">Logout</button></div>
      </div>

      <div class="grid grid-cols-4 gap-4 mb-6">
        <div class="glass p-4 rounded-xl">Active loans<br><div id="kpActive" class="text-2xl font-bold">—</div></div>
        <div class="glass p-4 rounded-xl">Total disbursed<br><div id="kpDisb" class="text-2xl font-bold">—</div></div>
        <div class="glass p-4 rounded-xl">Pending apps<br><div id="kpPending" class="text-2xl font-bold">—</div></div>
        <div class="glass p-4 rounded-xl">Overdue<br><div id="kpOverdue" class="text-2xl font-bold">—</div></div>
      </div>

      <section class="glass p-4 rounded-2xl">
        <h2 class="font-semibold mb-3">Applications Queue</h2>
        <div class="mb-3 flex items-center gap-3">
          <input id="appSearch" placeholder="Search by email or id" class="px-3 py-2 rounded bg-slate-800/50 text-sm w-64" />
          <select id="appStatus" aria-label="Filter by status" class="px-3 py-2 rounded bg-slate-800/50 text-sm"><option value="">All statuses</option><option value="submitted">Submitted</option><option value="approved">Approved</option><option value="rejected">Rejected</option></select>
          <select id="pageSize" aria-label="Results per page" class="px-3 py-2 rounded bg-slate-800/50 text-sm"><option>10</option><option selected>20</option><option>50</option></select>
          <button id="exportCsv" class="ml-auto py-1 px-3 rounded bg-slate-700/60 text-sm">Export CSV</button>
        </div>
        <div id="appsQueue">Loading...</div>
        <div id="appsPagination" class="mt-4 flex items-center gap-2"></div>
      </section>

  <!-- Confirm modal -->
  <div id="confirmOverlay" class="hidden fixed inset-0 z-50 items-center justify-center bg-black/50">
    <div class="bg-slate-900 p-4 rounded-lg w-96 text-slate-100">
      <div id="confirmText" class="mb-4">Are you sure?</div>
      <div class="flex justify-end gap-2"><button id="confirmCancel" class="px-3 py-1 rounded bg-slate-700">Cancel</button><button id="confirmOk" class="px-3 py-1 rounded bg-emerald-500 text-black">Confirm</button></div>
    </div>
  </div>
    </main>
  </div>

  <script src="UI.nomodule.js"></script>
  <script>
    async function initAdmin(){
      try{
        const me = await window.api.getMe(); if(me && me.user) document.getElementById('adminName').textContent = me.user.first_name || me.user.email;
      }catch(e){ console.warn(e); }

      // load apps (client-side filter + pagination using adminListApplications fallback)
      let _appsCache = [];
      async function loadApps(page=1){
        try{
          const q = (document.getElementById('appSearch').value || '').toLowerCase().trim();
          const status = document.getElementById('appStatus').value || '';
          const pageSize = parseInt(document.getElementById('pageSize').value || '20', 10);
          const res = await window.api.adminListApplications({ q, status, page, pageSize });
          const apps = (res && res.applications) ? res.applications : [];
          const total = res.total || apps.length;
          const pages = Math.max(1, Math.ceil((res.pages? res.pages*res.pageSize : total) / pageSize));
          document.getElementById('kpPending').textContent = total;
          const container = document.getElementById('appsQueue'); container.innerHTML = '';

          if(!apps.length) container.innerHTML = '<div class="text-sm text-slate-400">No applications</div>';
          apps.forEach(a=>{
            const el = document.createElement('div'); el.className = 'p-3 rounded-md border border-white/5 mb-2 flex items-center justify-between';
            el.innerHTML = `<div><div class='font-semibold'>${a.id.slice(0,8)} • ₹ ${Number(a.requested_amount).toLocaleString()}</div><div class='text-sm text-slate-300'>${a.status} • ${a.created_at} • ${a.user_email||''}</div></div><div class='flex gap-2'><button class='approve btn bg-emerald-500 text-black px-3 py-1 rounded' data-id='${a.id}'>Approve</button><button class='reject btn bg-rose-500 text-white px-3 py-1 rounded' data-id='${a.id}'>Reject</button></div>`;
            container.appendChild(el);
          });

          // wire actions with confirm modal
          document.querySelectorAll('.approve').forEach(b=> b.addEventListener('click', (e)=> openConfirm('approve', e.currentTarget.dataset.id)));
          document.querySelectorAll('.reject').forEach(b=> b.addEventListener('click', (e)=> openConfirm('reject', e.currentTarget.dataset.id)));

          renderPagination(page, Math.max(1, Math.ceil(total / pageSize)));

        }catch(err){ console.warn('apps load failed', err); document.getElementById('appsQueue').innerHTML = '<div class="text-sm text-rose-400">Failed to load</div>'; }
      }

      function renderPagination(current, pages){
        const pwrap = document.getElementById('appsPagination'); pwrap.innerHTML = '';
        for(let i=1;i<=pages;i++){
          const b = document.createElement('button'); b.textContent = i; b.className = 'px-2 py-1 rounded ' + (i===current? 'bg-brand text-black':'bg-slate-800/50');
          b.addEventListener('click', ()=> loadApps(i)); pwrap.appendChild(b);
        }
      }

      // confirm modal helpers
      let _pendingConfirm = null;
      function openConfirm(action, id){
        _pendingConfirm = { action, id };
        document.getElementById('confirmText').textContent = `Confirm ${action} for ${id.slice(0,8)}?`;
        document.getElementById('confirmOverlay').classList.remove('hidden'); document.getElementById('confirmOverlay').classList.add('flex');
      }

      document.getElementById('confirmCancel').addEventListener('click', ()=>{ _pendingConfirm = null; document.getElementById('confirmOverlay').classList.add('hidden'); document.getElementById('confirmOverlay').classList.remove('flex'); });
      document.getElementById('confirmOk').addEventListener('click', async ()=>{
        if(!_pendingConfirm) return;
        const { action, id } = _pendingConfirm; _pendingConfirm = null;
        document.getElementById('confirmOverlay').classList.add('hidden'); document.getElementById('confirmOverlay').classList.remove('flex');
        try{
          if(action === 'approve'){
            await window.api.adminApprove(id, { approved_amount: null, tenure_months: null, interest_rate: null });
            showSuccessDialog('Application approved','Loan created','admin.html',900);
          } else {
            const reason = prompt('Reason for rejection (optional)');
            await window.api.adminReject(id, reason || '');
            showToast('Application rejected');
          }
        }catch(err){ showToast(err.message || 'Action failed'); }
        setTimeout(()=> loadApps(), 500);
      });

      // CSV export
      document.getElementById('exportCsv').addEventListener('click', async ()=>{
        const q = encodeURIComponent(document.getElementById('appSearch').value || '');
        const status = encodeURIComponent(document.getElementById('appStatus').value || '');
        const url = `/api/admin/applications.csv?q=${q}&status=${status}`;
        try{
          const r = await fetch(url, { credentials:'include' });
          if(!r.ok) throw new Error('Export failed');
          const blob = await r.blob();
          const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'applications.csv'; document.body.appendChild(a); a.click(); a.remove();
        }catch(e){ showToast(e.message || 'CSV export failed'); }
      });

      // load KPIs from server-side admin dashboard when available
      async function loadKPIs(){
        try{
          const r = await window.api.getAdminDashboard();
          if(r && r.ok && r.data){
            document.getElementById('kpActive').textContent = r.data.active_loans || 0;
            document.getElementById('kpDisb').textContent = '₹ ' + (Number(r.data.total_disbursed||0)).toLocaleString();
            document.getElementById('kpPending').textContent = r.data.pending_apps || 0;
            document.getElementById('kpOverdue').textContent = r.data.overdue || 0;
          } else {
            // fallback
            const r2 = await fetch('/api/loans/admin/all', { credentials: 'include' });
            const json = await r2.json(); const loans = json.loans || json.rows || [];
            document.getElementById('kpActive').textContent = loans.length;
          }
        }catch(e){ console.warn('KPIs fetch failed', e); }
      }

      // wire filters to reload
      document.getElementById('appSearch').addEventListener('input', ()=> loadApps(1));
      document.getElementById('appStatus').addEventListener('change', ()=> loadApps(1));
      document.getElementById('pageSize').addEventListener('change', ()=> loadApps(1));

      loadApps(); loadKPIs();

      document.getElementById('adminLogout').addEventListener('click', async ()=>{ await window.api.logout().catch(()=>{}); location.href = 'admin-login.html'; });
    }
    document.addEventListener('DOMContentLoaded', initAdmin);
  </script>
</body>
</html>
